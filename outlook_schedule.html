<!DOCTYPE html>
<!-- 
  === URL Parameters ===
  You can modify the page behavior using query parameters:

    
	?count=tomorrow  → Show events until end of tomorrow (default if not specified)
    ?count=today     → Show only events happening today
    ?count=3         → Show only the next 3 upcoming events 
    ?count=this_week → Show events for the current week
    ?count=all       → Show all future events

    ?now=2025-06-26T15:30:00 
        → Simulate the current time (useful for testing)
        Format: ISO 8601 (e.g. YYYY-MM-DDTHH:mm:ss)

    ?private=1       → Force private event details to be visible
    ?trans=1         → Makes the background transparent for embedding over a video/slideshow
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/dseg-fonts@2.0.0/dseg.css" rel="stylesheet">

  <title>Upcoming Events</title>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: sans-serif;
      padding: 2em;
    }
    h1 {
      font-size: 2em;
      text-align: center;
    }
	#fullscreen, #add-event-modal, #image-viewer-modal {
	  display: none;
	  position: fixed;
	  inset: 0;
	  background: rgba(0,0,0,0.95);
	  z-index: 1000;
	  padding: 3em 1em 1em 1em;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
	}
    .event {
      background-color: #222;
      border: 1px solid #555;
      border-radius: 12px;
      padding: 1em;
      margin-bottom: 1em;
      box-shadow: 0 2px 5px rgba(255, 255, 255, 0.1);
      position: relative;
      cursor: pointer;
      transition: transform 0.5s ease, opacity 0.5s ease;
    }
    .event strong {
      font-size: 1.2em;
      color: #4fc3f7;
    }
    .event.custom-colored strong {
        color: inherit; /* Let the parent's color take over */
    }
    .time-until {
      position: absolute;
      bottom: 8px;
      right: 12px;
      font-size: 0.9em;
      color: #ccc;
    }
    .big-time {
      position: static;
      font-size: 2em;
      font-weight: bold;
      color: #fff;
      text-align: center;
    }
    .starting-soon {
      border-color: orange;
      animation: pulseOrange 2s infinite alternate ease-in-out;
    }
    @keyframes pulseOrange {
      from { box-shadow: 0 0 10px orange; }
      to { box-shadow: 0 0 20px orange; }
    }
    .final-countdown {
      border-color: red;
      animation: pulseRed 2s infinite alternate ease-in-out;
      background-color: #400;
    }
    @keyframes pulseRed {
      from { box-shadow: 0 0 20px 5px red; background-color: #600; }
      to { box-shadow: 0 0 40px 15px red; background-color: #900; }
    }
    .happening-now {
      border-color: #aeefff;
      animation: pulseBlue 2s infinite alternate ease-in-out;
      background-color: #99ccff;
      color: black;
    }
    .happening-now.custom-colored {
        color: inherit; /* Let custom color override */
    }
    @keyframes pulseBlue {
      from { box-shadow: 0 0 10px #ffffff; background-color: #cceeff; }
      to { box-shadow: 0 0 20px #ffffff; background-color: #e0f7ff; }
    }
    .slide-out {
      transform: translateX(-100%);
      opacity: 0;
    }
    .slide-in {
      transform: translateX(100%);
      opacity: 0;
    }
    .slide-in-active {
      transform: translateX(0);
      opacity: 1;
    }
	.event-animating {
	  transition: transform 0.5s cubic-bezier(.34,1.56,.64,1);
	  z-index: 0;
	}
	.details-card, .modal-card {
	  background: #16181e;
	  border-radius: 16px;
	  box-shadow: 0 4px 24px rgba(80,200,255,0.12);
	  padding: 2em 2em 1.5em 2em;
	  color: #fff;
	  max-width: 450px;
	  margin: 2em auto 0 auto;
	  font-size: 1.08em;
	  border: 1.5px solid #4fc3f7;
    position: relative;
	}

	.details-title, .modal-title {
	  font-size: 1.7em;
	  color: #4fc3f7;
	  font-weight: 600;
	  margin-bottom: 0.4em;
	  text-align: center;
	  letter-spacing: 0.01em;
	}

	.details-row, .modal-row {
	  margin-bottom: 0.7em;
	  display: flex;
      flex-wrap: wrap;
	  justify-content: flex-start;
	  gap: 0.5em;
	}

	.details-label, .modal-label {
	  color: #aeefff;
	  min-width: 90px;
	  font-weight: 500;
	  display: inline-block;
      padding-top: 0.5em;
	}

	.details-date {
	  font-size: 1.1em;
	  color: #fff;
	  font-weight: 500;
	  margin-bottom: 1em;
	}

	.details-description {
	  margin-top: 1.5em;
	  font-size: 1em;
	  color: #dbefff;
	  line-height: 1.5;
	}
    .details-image-gallery {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }
    .details-image-gallery img {
        max-width: 80px;
        max-height: 80px;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid #4fc3f7;
    }

	.details-description .details-label {
	  min-width: 0;
	  font-weight: 600;
	  color: #4fc3f7;
	}

	.close-btn {
	  position: absolute;
	  top: 1em;
	  right: 1.2em;
	  background: #0c1820;
	  color: #4fc3f7;
	  border: none;
	  font-size: 2em;
	  font-weight: bold;
	  border-radius: 50%;
	  width: 1.6em;
	  height: 1.6em;
	  line-height: 1.2em;
	  text-align: center;
	  cursor: pointer;
	  box-shadow: 0 2px 10px #0005;
	  transition: background 0.2s, color 0.2s;
	  z-index: 10;
	}
	.close-btn:hover {
	  background: #223344;
	  color: #fff;
	}

    .date-divider {
      border-top: 2px solid #4fc3f7;
      margin: 1em 0;
      padding-top: 0.5em;
      font-size: 1.2em;
      color: #4fc3f7;
      text-align: center;
    }
	.event-time-row {
	  display: flex;
	  align-items: center;
	  gap: 1.3em;
	  font-size: 1.02em;
	  margin-bottom: 0.5em;
	}

	.event-duration {
	  color: #bbb;
	  font-size: 0.99em;
	}

	.event-dot {
	  color: #4fc3f7;
	  font-size: 1.3em;
	  line-height: 0.5;
	  margin-top: -2px;
	}
	
	/* Glow and pop-in for auto-triggered details */
	@keyframes popIn {
	  from {
		transform: scale(0.6);
		opacity: 0;
	  }
	  to {
		transform: scale(1);
		opacity: 1;
	  }
	}
#fullscreen.auto-glow .details-card {
  animation: popIn 0.3s ease-out, pulseJoinNow 0.6s ease-in-out infinite alternate;
  border-color: #33f3ff;
  box-shadow: 0 0 40px 20px #33f3ff;
  z-index: 2000;
}

@keyframes pulseJoinNow {
  from {
    box-shadow: 0 0 40px 10px #33f3ff;
    background-color: #0a2c38;
    border-color: #33f3ff;
  }
  to {
    box-shadow: 0 0 90px 40px #66fcff;
    background-color: #00475c;
    border-color: #66fcff;
  }
}


#current-time {
  font-family: 'DSEG7Classic-Regular', monospace;
  font-size: 4.5em;
  color: #33f3ff;
  text-align: center;
  letter-spacing: 0.12em;
  text-shadow:
    0 0 2px #0ff,
    0 0 4px #0ff;
}

/* --- All Day Events Styles --- */
#all-day-container {
    text-align: center;
    margin-bottom: 1.5em;
    padding: 1em 0;
    border-bottom: 1px solid #444;
}
.all-day-event {
    display: inline-block;
    background: #2a3b4d;
    color: #cdefff;
    padding: 0.4em 1em;
    border-radius: 16px;
    margin: 0 0.5em 0.5em 0;
    border: 1px solid #4fc3f7;
    font-size: 1em;
    cursor: pointer;
    transition: background-color 0.2s;
}
.all-day-event:hover {
    background-color: #4fc3f7;
    color: black;
}
.all-day-title {
    font-size: 1.2em;
    color: #4fc3f7;
    margin-bottom: 0.75em;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

/* --- Two-Column Layout Styles --- */
#main-content-wrapper {
    display: block; /* Default layout */
}
body.layout-split-column #main-content-wrapper {
    display: flex;
    gap: 2em;
    align-items: flex-start;
}
body.layout-split-column #all-day-container {
    flex: 1;
    max-width: 350px;
    border-bottom: none;
    padding: 0;
    margin-bottom: 0;
    text-align: left;
}
body.layout-split-column #events {
    flex: 2;
}
body.layout-split-column .all-day-event {
    display: block; /* Stack vertically in column */
    margin-bottom: 0.75em;
}


/* --- Settings & Add Button Styles --- */
.action-btn {
  position: fixed;
  top: 1.5em;
  width: 3em;
  height: 3em;
  background: #223344;
  color: #aeefff;
  border: 1.5px solid #4fc3f7;
  border-radius: 50%;
  font-size: 1.5em;
  cursor: pointer;
  z-index: 2000;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}
#settings-btn {
  left: 1.5em;
}
#add-event-btn {
  right: 1.5em;
}
.action-btn:hover {
  background: #4fc3f7;
  color: black;
  transform: rotate(45deg);
}
body.modal-open .action-btn {
    display: none;
}
#settings-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 3000;
  padding: 2em;
  align-items: center;
  justify-content: center;
}
.settings-panel {
  background: #16181e;
  border-radius: 16px;
  padding: 2em;
  color: #fff;
  max-width: 500px;
  width: 100%;
  border: 1.5px solid #4fc3f7;
  position: relative;
}
.settings-panel h2 {
  text-align: center;
  font-size: 1.7em;
  color: #4fc3f7;
  margin-top: 0;
}
.setting-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5em;
  font-size: 1.1em;
}
.setting-row label {
  color: #aeefff;
  font-weight: 500;
}
.setting-row input[type="text"] {
  background: #0c1820;
  color: white;
  border: 1px solid #4fc3f7;
  border-radius: 6px;
  padding: 0.5em;
  min-width: 200px;
}
#save-settings-btn, #save-event-btn {
  display: block;
  width: 100%;
  padding: 0.8em;
  background: #4fc3f7;
  color: black;
  border: none;
  border-radius: 8px;
  font-size: 1.2em;
  font-weight: bold;
  cursor: pointer;
  margin-top: 1em;
}

/* Styles for radio buttons */
.count-options-fieldset {
    border: 1px solid #4fc3f7;
    border-radius: 8px;
    padding: 1em;
    margin-bottom: 1.5em;
}
.count-options-fieldset legend {
    color: #aeefff;
    font-weight: 500;
    padding: 0 0.5em;
}
.radio-option {
    display: flex;
    align-items: center;
    margin-bottom: 0.75em;
}
.radio-option label {
    margin-left: 0.5em;
    flex-grow: 1;
}
#custom-count-input {
    width: 60px;
    margin-left: 0.5em;
    background: #0c1820;
    color: white;
    border: 1px solid #4fc3f7;
    border-radius: 4px;
    padding: 0.2em 0.5em;
}
#custom-count-input:disabled {
    background: #333;
    border-color: #555;
    cursor: not-allowed;
}

/* --- Slider Toggle Styles --- */
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
}
.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #333;
  transition: .4s;
  border-radius: 28px;
  border: 1px solid #4fc3f7;
}
.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 3px;
  bottom: 3px;
  background-color: #aeefff;
  transition: .4s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: #4fc3f7;
}
input:checked + .slider:before {
  transform: translateX(22px);
  background-color: #0c1820;
}

/* --- Hide/Unhide/Edit Event Button Styles --- */
.details-action-btn-group {
    display: flex;
    gap: 1em;
    justify-content: center;
    margin-top: 1.5em;
}
.details-action-btn {
    padding: 0.5em 1em;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid;
}
#hide-event-btn, #unhide-event-btn {
    background: #5a3a00;
    color: #ffcc80;
    border-color: #ffcc80;
}
#hide-event-btn:hover, #unhide-event-btn:hover {
    background: #ffcc80;
    color: #5a3a00;
}
#edit-event-btn {
    background: #1a237e;
    color: #9fa8da;
    border-color: #9fa8da;
}
#edit-event-btn:hover {
    background: #9fa8da;
    color: #1a237e;
}
#delete-event-btn {
    background: #610404;
    color: #ff9a9a;
    border-color: #ff9a9a;
}
#delete-event-btn.confirm-delete {
    background: #ff0000;
    color: white;
    border-color: white;
}


/* --- Drag and Drop Marker --- */
#drop-marker {
    display: none;
    position: absolute;
    width: 100%;
    height: 4px;
    background-color: #ff5722;
    z-index: 500;
    pointer-events: none;
    box-shadow: 0 0 10px #ff5722;
}

.modal-card input[type="text"], 
.modal-card input[type="datetime-local"], 
.modal-card input[type="color"], 
.modal-card textarea {
    background: #0c1820;
    color: white;
    border: 1px solid #4fc3f7;
    border-radius: 6px;
    padding: 0.5em;
    box-sizing: border-box;
}
.modal-card input[type="text"],
.modal-card input[type="datetime-local"],
.modal-card textarea {
    width: 100%;
}
.modal-card .color-picker-wrapper {
    display: flex;
    justify-content: space-around;
    align-items: center;
}
.modal-card input[type="color"] {
    width: 50px;
    height: 40px;
    padding: 2px;
}
#image-drop-zone {
    border: 2px dashed #4fc3f7;
    border-radius: 8px;
    padding: 1em;
    text-align: center;
    color: #aeefff;
    margin-top: 1em;
    transition: background-color 0.2s;
}
#image-drop-zone.drag-over {
    background-color: #223344;
}
#image-preview-gallery {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
    justify-content: center;
}
.thumbnail-container {
    position: relative;
}
.thumbnail-container img {
    max-width: 80px;
    max-height: 80px;
    border-radius: 8px;
}
.thumbnail-remove-btn {
    position: absolute;
    top: -5px;
    right: -5px;
    background: red;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    font-weight: bold;
}
#image-viewer-modal img {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
}
.quick-edit-section {
    border-top: 1px solid #444;
    margin-top: 1.5em;
    padding-top: 1em;
}
.quick-edit-section .color-picker-wrapper {
    justify-content: space-evenly;
}


  </style>
</head>
<body>
  <button id="settings-btn" class="action-btn" title="Settings">⚙️</button>
  <button id="add-event-btn" class="action-btn" title="Add Event">+</button>
  <div id="current-time">Loading time...</div>
  
  <div id="main-content-wrapper">
    <div id="all-day-container"></div>
    <div id="events">
        <div id="drop-marker"></div>
    </div>
  </div>

  <div id="fullscreen">
	  <div class="content" id="fullscreen-content"></div>
	</div>
  
  <div id="image-viewer-modal">
      <button class="close-btn">&times;</button>
      <img src="" alt="Full size event image">
  </div>

  <div id="add-event-modal" style="display: none;">
    <div class="modal-card">
        <button class="close-btn" id="add-event-close-btn">&times;</button>
        <h2 class="modal-title">Add New Event</h2>
        <div class="modal-row">
            <label for="event-summary" class="modal-label">Summary</label>
            <input type="text" id="event-summary" placeholder="e.g., Team Meeting">
        </div>
        <div class="modal-row">
            <label for="event-start" class="modal-label">Start Time</label>
            <input type="datetime-local" id="event-start">
        </div>
        <div class="modal-row">
            <label for="event-end" class="modal-label">End Time</label>
            <input type="datetime-local" id="event-end">
        </div>
        <div class="modal-row">
            <label for="event-description" class="modal-label">Description</label>
            <textarea id="event-description" rows="3"></textarea>
        </div>
        <div id="image-drop-zone">
            Drop images here or paste from clipboard
            <div id="image-preview-gallery"></div>
        </div>
        <div class="modal-row color-picker-wrapper">
            <div>
                <label for="event-bg-color" class="modal-label">Background</label>
                <input type="color" id="event-bg-color" value="#37474f">
            </div>
            <div>
                <label for="event-text-color" class="modal-label">Text</label>
                <input type="color" id="event-text-color" value="#eceff1">
            </div>
        </div>
        <button id="save-event-btn">Save Event</button>
    </div>
  </div>

  <div id="settings-modal">
    <div class="settings-panel">
      <button class="close-btn" id="settings-close-btn">&times;</button>
      <h2>Settings</h2>

      <fieldset class="count-options-fieldset">
        <legend>Show Events</legend>
        <div class="radio-option">
            <input type="radio" id="count-tomorrow" name="count-type" value="tomorrow">
            <label for="count-tomorrow">Today & Tomorrow</label>
        </div>
        <div class="radio-option">
            <input type="radio" id="count-today" name="count-type" value="today">
            <label for="count-today">Today Only</label>
        </div>
        <div class="radio-option">
            <input type="radio" id="count-this_week" name="count-type" value="this_week">
            <label for="count-this_week">This Week</label>
        </div>
        <div class="radio-option">
            <input type="radio" id="count-all" name="count-type" value="all">
            <label for="count-all">All Future Events</label>
        </div>
        <div class="radio-option">
            <input type="radio" id="count-custom" name="count-type" value="custom">
            <label for="count-custom">Next</label>
            <input type="number" id="custom-count-input" min="1" value="3" disabled>
            <span>&nbsp;events</span>
        </div>
      </fieldset>

      <div class="setting-row">
        <label for="layout-setting">Split Column Layout</label>
        <label class="switch">
            <input type="checkbox" id="layout-setting">
            <span class="slider"></span>
        </label>
      </div>
      <div class="setting-row">
        <label for="private-setting">Show Private Details</label>
        <label class="switch">
            <input type="checkbox" id="private-setting">
            <span class="slider"></span>
        </label>
      </div>
      <div class="setting-row">
        <label for="trans-setting">Transparent BG</label>
        <label class="switch">
            <input type="checkbox" id="trans-setting">
            <span class="slider"></span>
        </label>
      </div>
      <div class="setting-row">
        <label for="show-hidden-setting">Show Hidden Events</label>
        <label class="switch">
            <input type="checkbox" id="show-hidden-setting">
            <span class="slider"></span>
        </label>
      </div>
      <div class="setting-row">
        <label for="file-setting">Data File Name</label>
        <input type="text" id="file-setting">
      </div>
      <button id="save-settings-btn">Save & Reload</button>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
	
	const defaults = {
		file: 'sample_events.csv',
		count: 'tomorrow',
		private: false,
		trans: false,
        showHidden: false,
        layout: 'top' // 'top' or 'split'
	};
	let settings = { ...defaults, ...JSON.parse(localStorage.getItem('eventSettings')) };
    let hiddenEvents = new Set(JSON.parse(localStorage.getItem('hiddenEvents')) || []);
    let customEvents = JSON.parse(localStorage.getItem('customEvents')) || [];
    let imageUrls = []; // Temp store for image data URLs
    let currentlyEditingEventId = null;

	// URL parameters have priority over saved settings
	const fileName = urlParams.get('file') || settings.file;
	const countParam = urlParams.get('count') || settings.count;
	const privateOverride = urlParams.has('private') ? urlParams.get('private') === '1' : settings.private;
	const transparentBg = urlParams.has('trans') ? urlParams.get('trans') === '1' : settings.trans;
    const showHiddenOverride = urlParams.has('showHidden') ? urlParams.get('showHidden') === '1' : settings.showHidden;
    const layoutOverride = urlParams.get('layout') || settings.layout;


    const nowParam = urlParams.get('now');
	const shownEventDetails = new Set();
	let autoCloseTimeout = null;
	const autoCloseDuration = 10000;

	if (transparentBg) {
	  const style = document.createElement('style');
	  style.textContent = `
		body { background: transparent !important; }
		#fullscreen, #add-event-modal { background: transparent !important; }
		.details-card, .event, .modal-card {
		  background: rgba(30,40,60,0.8) !important;
		}
	  `;
	  document.head.appendChild(style);
	}
    if (layoutOverride === 'split') {
        document.body.classList.add('layout-split-column');
    }

	
    let fakeNow = nowParam ? new Date(nowParam) : null;
    let eventsData = [];

	// --- Settings Management Functions ---
	function updateSettingsForm() {
        document.getElementById('file-setting').value = fileName;
        document.getElementById('private-setting').checked = privateOverride;
        document.getElementById('trans-setting').checked = transparentBg;
        document.getElementById('show-hidden-setting').checked = showHiddenOverride;
        document.getElementById('layout-setting').checked = layoutOverride === 'split';

        // Handle radio buttons for 'count'
        const customCountInput = document.getElementById('custom-count-input');
        if (/^\d+$/.test(countParam)) {
            document.getElementById('count-custom').checked = true;
            customCountInput.value = countParam;
            customCountInput.disabled = false;
        } else {
            const radio = document.getElementById(`count-${countParam}`);
            if (radio) radio.checked = true;
            else document.getElementById('count-tomorrow').checked = true; // Default
            customCountInput.disabled = true;
        }
	}

	function saveSettings() {
        let countValue;
        if (document.getElementById('count-custom').checked) {
            countValue = document.getElementById('custom-count-input').value || '3';
        } else {
            countValue = document.querySelector('input[name="count-type"]:checked').value;
        }

		const newSettings = {
			file: document.getElementById('file-setting').value,
			count: countValue,
			private: document.getElementById('private-setting').checked,
			trans: document.getElementById('trans-setting').checked,
            showHidden: document.getElementById('show-hidden-setting').checked,
            layout: document.getElementById('layout-setting').checked ? 'split' : 'top'
		};
		localStorage.setItem('eventSettings', JSON.stringify(newSettings));
		alert('Settings saved. The page will now reload to apply them.');
		// Reload the page at its base path, clearing any URL params
		window.location.href = window.location.pathname;
	}
	
	function setupSettingsModal() {
		const settingsBtn = document.getElementById('settings-btn');
		const settingsModal = document.getElementById('settings-modal');
		const closeBtn = document.getElementById('settings-close-btn');
		const saveBtn = document.getElementById('save-settings-btn');
        const countRadios = document.querySelectorAll('input[name="count-type"]');
        const customCountInput = document.getElementById('custom-count-input');
		
		settingsBtn.onclick = () => {
			updateSettingsForm(); // Ensure form shows current settings
			setModalOpenState(true);
			settingsModal.style.display = 'flex'; // Use flex to center the panel
		};
		closeBtn.onclick = () => {
            setModalOpenState(false);
            settingsModal.style.display = 'none';
        }
		saveBtn.onclick = saveSettings;
		// Close if user clicks outside the panel
		settingsModal.onclick = (e) => {
			if (e.target === settingsModal) {
				setModalOpenState(false);
                settingsModal.style.display = 'none';
			}
		};

        // Enable/disable custom count input
        countRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                customCountInput.disabled = (radio.value !== 'custom');
            });
        });
	}

    function cleanupHiddenEvents() {
        const now = fakeNow ? new Date(fakeNow.getTime()) : new Date();
        let changed = false;
        const allKnownEvents = [...eventsData, ...customEvents];
        const allEventIds = new Set(allKnownEvents.map(generateId));
        
        hiddenEvents.forEach(id => {
            const event = allKnownEvents.find(e => generateId(e) === id);
            // Remove if event is over OR if it's no longer in the main data source
            if (!event || new Date(event.end) < now) {
                hiddenEvents.delete(id);
                changed = true;
            }
        });

        if (changed) {
            localStorage.setItem('hiddenEvents', JSON.stringify(Array.from(hiddenEvents)));
        }
    }

    function updateTime() {
	  const now = fakeNow ? new Date(fakeNow.getTime()) : new Date();
	  document.getElementById('current-time').innerText = now.toLocaleTimeString();
	  if (fakeNow) fakeNow.setSeconds(fakeNow.getSeconds() + 1);

	  // Only updates timers, does not trigger full render
	  Array.from(document.querySelectorAll('.event')).forEach(el => {
		const start = new Date(el.dataset.start);
		const end = new Date(el.dataset.end);
		const msUntil = start - now;
		const msUntilEnd = end - now;
		const timeDiv = el.querySelector('.time-until, .big-time');

		// --- LOGIC TO UPDATE COLOURS/CLASSES DYNAMICALLY ---
		el.classList.remove('happening-now', 'final-countdown', 'starting-soon');
		if ((start <= now) && (end > now)) {
		  el.classList.add('happening-now');
		  const eventId = el.dataset.id;
		  const msSinceStart = now - start;
		  
		  if (msSinceStart <= autoCloseDuration && !shownEventDetails.has(eventId)) {
			shownEventDetails.add(eventId);
			showDetailsById(eventId, { glow: true });
		  }

		} else if (msUntil > 0 && msUntil <= 2 * 60 * 1000) {
		  el.classList.add('final-countdown');
		} else if (msUntil > 2 * 60 * 1000 && msUntil < 10 * 60 * 1000) {
		  el.classList.add('starting-soon');
		}

		if (end <= now && !el.classList.contains('slide-out')) {
		  el.classList.remove('slide-in', 'slide-in-active');
		  el.classList.add('slide-out');
		  setTimeout(() => el.remove(), 500);
		}
		if (timeDiv) {
		  timeDiv.className = (msUntil > 0 && msUntil < 10 * 60 * 1000) ? 'big-time' : 'time-until';
		  timeDiv.textContent = msUntil > 0 ? formatDuration(msUntil) : (end > now ? 'Happening now' : 'Started');
		}
	  });
	}

	function formatDurationMinutes(start, end) {
	  const ms = end - start;
	  const totalMinutes = Math.round(ms / 60000);
	  const hours = Math.floor(totalMinutes / 60);
	  const minutes = totalMinutes % 60;
	  let text = '';
	  if (hours > 0) text += `${hours} hour${hours !== 1 ? 's' : ''} `;
	  if (minutes > 0 || hours === 0) text += `${minutes} min${minutes !== 1 ? 's' : ''}`;
	  return text.trim();
	}

    function generateId(e) {
      // Custom events might not have a start time if created improperly, guard against it.
      const startTime = e.start || new Date().toISOString();
      return `${startTime}_${e.summary}`;
    }

    function isAllDayEvent(e) {
        const start = new Date(e.start);
        const end = new Date(e.end);
        const durationHours = (end - start) / (1000 * 60 * 60);
        const startsAtMidnight = start.getHours() === 0 && start.getMinutes() === 0 && start.getSeconds() === 0;
        // Use >= 23 hours to account for daylight saving changes
        return durationHours >= 23 && startsAtMidnight;
    }

    function renderTodaysAllDayEvents(events, now) {
        const container = document.getElementById('all-day-container');
        container.innerHTML = ''; // Clear previous content

        if (events.length > 0) {
            const title = document.createElement('div');
            title.className = 'all-day-title';
            title.textContent = "Today's All-Day Events";
            container.appendChild(title);

            events.forEach(e => {
                const el = document.createElement('div');
                el.className = 'all-day-event';
                el.textContent = e.summary;
                if (e.bgColor) el.style.backgroundColor = e.bgColor;
                if (e.textColor) el.style.color = e.textColor;
                el.onclick = () => showDetailsById(generateId(e));
                container.appendChild(el);
            });
        }
    }

    function renderEvents(now) {
      cleanupHiddenEvents();
	  
      const allEventsMap = new Map();
      eventsData.forEach(e => allEventsMap.set(generateId(e), e));
      customEvents.forEach(e => allEventsMap.set(generateId(e), e));
      const allKnownEvents = Array.from(allEventsMap.values());

      const visibleEvents = allKnownEvents.filter(e => {
        const id = generateId(e);
        const isHidden = hiddenEvents.has(id) && !showHiddenOverride;
        return !isHidden && e.rsvp !== 'declined' && new Date(e.end) >= now && e.ooo !== 'yes';
      });

      const todaysAllDayEvents = [];
      const otherEvents = [];

      visibleEvents.forEach(e => {
          if (isAllDayEvent(e) && isSameDay(new Date(e.start), now)) {
              todaysAllDayEvents.push(e);
          } else {
              otherEvents.push(e);
          }
      });

      renderTodaysAllDayEvents(todaysAllDayEvents, now);

      let filtered = otherEvents.sort((a, b) => new Date(a.start) - new Date(b.start));

      if (/^\d+$/.test(countParam)) {
        filtered = filtered.slice(0, parseInt(countParam));
      } else if (countParam === 'today') {
        filtered = filtered.filter(e => isSameDay(new Date(e.start), now));
      } else if (countParam === 'tomorrow') {
        const tomorrow = new Date(now);
        tomorrow.setDate(now.getDate() + 1);
        filtered = filtered.filter(e => isSameDay(new Date(e.start), tomorrow) || isSameDay(new Date(e.start), now));
      } else if (countParam === 'this_week') {
        const endOfWeek = new Date(now);
        endOfWeek.setDate(now.getDate() + (7 - now.getDay()));
        endOfWeek.setHours(23, 59, 59, 999);
        filtered = filtered.filter(e => new Date(e.start) <= endOfWeek);
      } else if (countParam !== 'all') {
        // This is a fallback, 'all' will show all timedEvents
      }

      const eventsDiv = document.getElementById('events');
      const existingEls = Array.from(eventsDiv.querySelectorAll('.event'));
      const newIds = filtered.map(generateId);
      const elsToRemove = existingEls.filter(el => !newIds.includes(el.dataset.id));
      const newEvents = filtered.filter(e => !document.querySelector(`[data-id="${generateId(e)}"]`));

      removeEventsSequentially(elsToRemove, () => {
        insertEventsSequentially(newEvents, now);
      });
    }

    function removeEventsSequentially(els, callback, index = 0) {
		  if (index >= els.length) return callback();
		  const el = els[index];
		  el.classList.remove('slide-in', 'slide-in-active');
		  el.classList.add('slide-out');

		  const eventsDiv = document.getElementById('events');
		  Array.from(eventsDiv.children).forEach(child => {
			if (child.classList && child.classList.contains('event') && child !== el) {
			  child.classList.remove('slide-in', 'slide-in-active', 'slide-out');
			}
		  });

		  const prevRects = [];
		  Array.from(eventsDiv.children).forEach(child => {
			if (child !== el && child.classList.contains('event')) {
			  prevRects.push({
				el: child,
				top: child.getBoundingClientRect().top
			  });
			}
		  });

		  setTimeout(() => {
			el.remove();

			const newRects = [];
			Array.from(eventsDiv.children).forEach(child => {
			  if (child.classList.contains('event')) {
				newRects.push({
				  el: child,
				  top: child.getBoundingClientRect().top
				});
			  }
			});

			newRects.forEach((newRect, i) => {
			  const prevRect = prevRects.find(r => r.el === newRect.el);
			  if (prevRect) {
				const dy = prevRect.top - newRect.top;
				if (dy) {
				  newRect.el.classList.add('event-animating');
				  newRect.el.style.transform = `translateY(${dy}px)`;
				  void newRect.el.offsetWidth;
				  newRect.el.style.transform = '';
				  setTimeout(() => newRect.el.classList.remove('event-animating'), 500);
				}
			  }
			});

			removeEventsSequentially(els, callback, index + 1);
		  }, 500);
		}

	function showDetailsById(id, options = {}) {
	  const allEventsMap = new Map();
      eventsData.forEach(e => allEventsMap.set(generateId(e), e));
      customEvents.forEach(e => allEventsMap.set(generateId(e), e));
	  const e = allEventsMap.get(id);

	  if (!e) {
		console.error("Sorry, event not found for ID:", id);
		return;
	  }

		const fullscreen = document.getElementById('fullscreen');
        setModalOpenState(true);
		if (autoCloseTimeout) {
			clearTimeout(autoCloseTimeout);
			autoCloseTimeout = null;
		}
		  
		if (options.glow && !isAllDayEvent(e)) { // Don't auto-glow for all-day events
			fullscreen.classList.add('auto-glow');
			autoCloseTimeout = setTimeout(() => {
			  fullscreen.style.display = 'none';
			  fullscreen.classList.remove('auto-glow');
              setModalOpenState(false);
			}, autoCloseDuration); 
		} else {
			fullscreen.classList.remove('auto-glow');
		}

	  const startDate = new Date(e.start);
	  const endDate = new Date(e.end);
	  const dateString = startDate.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
	  const startTime = formatTimeOnly(startDate);
	  const endTime = formatTimeOnly(endDate);
	  const duration = formatDurationMinutes(startDate, endDate);
	  const rsvp = e.rsvp ? e.rsvp.charAt(0).toUpperCase() + e.rsvp.slice(1) : 'Accepted';
	  const privacy = e.private === 'yes' ? "Private" : "Public";
      
      const isHidden = hiddenEvents.has(id);
      const buttonId = isHidden ? 'unhide-event-btn' : 'hide-event-btn';
      const buttonText = isHidden ? 'Unhide this event' : 'Hide this event';
      
      let actionButtonsHTML = `<div class="details-action-btn-group">`;
      // Any event can be edited. This will create a custom override if it's a calendar event.
      actionButtonsHTML += `<button id="edit-event-btn" class="details-action-btn" data-id="${id}">Edit</button>`;
      if (e.isCustom) {
          actionButtonsHTML += `<button id="delete-event-btn" class="details-action-btn" data-id="${id}">Delete</button>`;
      }
      actionButtonsHTML += `<button id="${buttonId}" class="details-action-btn" data-id="${id}">${buttonText}</button>`;
      actionButtonsHTML += `</div>`;
      
      let descriptionHTML = '';
      if (privateOverride || e.private !== 'yes') {
          try {
              const descObj = JSON.parse(e.description);
              if (descObj.images && descObj.images.length > 0) {
                  descriptionHTML += '<div class="details-image-gallery">';
                  descObj.images.forEach(imgSrc => {
                      descriptionHTML += `<img src="${imgSrc}" onclick="showImageViewer('${imgSrc}')">`;
                  });
                  descriptionHTML += '</div>';
              }
              if (descObj.text) {
                  descriptionHTML += `<p>${descObj.text}</p>`;
              }
          } catch (err) {
              descriptionHTML = e.description || '<i>No description</i>';
          }
      } else {
          descriptionHTML = '<i>Details hidden</i>';
      }


	  document.getElementById('fullscreen-content').innerHTML = `
		  <div class="details-card">
			<button class="close-btn">&times;</button>
			<div class="details-title">${e.summary}</div>
			<div class="details-row details-date"><span class="details-label">Date:</span> ${dateString}</div>
            ${!isAllDayEvent(e) ? `<div class="details-row"><span class="details-label">Time:</span> ${startTime} &ndash; ${endTime}</div>` : ''}
			<div class="details-row"><span class="details-label">Duration:</span> ${duration}</div>
			<div class="details-row"><span class="details-label">RSVP:</span> ${rsvp}</div>
			<div class="details-row"><span class="details-label">Privacy:</span> ${privacy}</div>
			<div class="details-description">
			  <span class="details-label">Description:</span>
			  <div>${descriptionHTML}</div>
			</div>
            ${actionButtonsHTML}
		  </div>
		`;
      
      const closeFullscreen = () => {
          document.getElementById('fullscreen').style.display = 'none';
          document.getElementById('fullscreen').classList.remove('auto-glow');
          if (window.autoCloseTimeout) { clearTimeout(window.autoCloseTimeout); autoCloseTimeout = null; }
          setModalOpenState(false);
      };

      document.querySelector('#fullscreen-content .close-btn').onclick = closeFullscreen;
      
      document.getElementById(buttonId).onclick = (evt) => {
          const eventIdToToggle = evt.target.dataset.id;
          if (hiddenEvents.has(eventIdToToggle)) {
              hiddenEvents.delete(eventIdToToggle);
          } else {
              hiddenEvents.add(eventIdToToggle);
          }
          localStorage.setItem('hiddenEvents', JSON.stringify(Array.from(hiddenEvents)));
          closeFullscreen();
          renderEvents(fakeNow || new Date());
      };

      document.getElementById('edit-event-btn').onclick = () => {
          closeFullscreen();
          openAddEventModal(e, true);
      };
      
      if (e.isCustom) {
          const deleteBtn = document.getElementById('delete-event-btn');
          let deleteTimeout = null;
          deleteBtn.onclick = (evt) => {
              if (deleteBtn.classList.contains('confirm-delete')) {
                  const eventIdToDelete = evt.target.dataset.id;
                  customEvents = customEvents.filter(event => generateId(event) !== eventIdToDelete);
                  localStorage.setItem('customEvents', JSON.stringify(customEvents));
                  closeFullscreen();
                  renderEvents(fakeNow || new Date());
              } else {
                  deleteBtn.classList.add('confirm-delete');
                  deleteBtn.textContent = 'Confirm?';
                  deleteTimeout = setTimeout(() => {
                      deleteBtn.classList.remove('confirm-delete');
                      deleteBtn.textContent = 'Delete';
                  }, 3000);
              }
          };
      }

	  fullscreen.style.display = 'flex';
	}


    function insertEventsSequentially(events, now, index = 0, lastDateStr = '') {
      if (index >= events.length) return;
      const e = events[index];
      const id = generateId(e);
      const start = new Date(e.start);
      const end = new Date(e.end);
      const msUntil = start - now;

      let cssClass = 'event';
      if ((start <= now) && (end > now)) cssClass += ' happening-now';
      else if (msUntil > 0 && msUntil <= 2 * 60 * 1000) cssClass += ' final-countdown';
      else if (msUntil > 2 * 60 * 1000 && msUntil < 10 * 60 * 1000) cssClass += ' starting-soon';

      let timeClass = 'time-until';
      if (msUntil > 0 && msUntil < 10 * 60 * 1000) timeClass = 'big-time';

      const dateStr = start.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

      const eventsDiv = document.getElementById('events');

      if (dateStr !== lastDateStr && !isAllDayEvent(e)) {
		  let needDivider = true;
		  let insertBefore = null;

		  for (let child of eventsDiv.children) {
			if (child.classList.contains('event')) {
			  const childStart = new Date(child.dataset.start);
			  const childDateStr = childStart.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

			  if (dateStr === childDateStr) {
				if (child.previousElementSibling && child.previousElementSibling.classList.contains('date-divider') && child.previousElementSibling.textContent === dateStr) {
				  needDivider = false;
				} else {
				  insertBefore = child;
				}
				break;
			  }
			}
		  }

		  if (needDivider) {
			const divider = document.createElement('div');
			divider.className = 'date-divider';
			divider.textContent = dateStr;
			if (insertBefore) {
			  eventsDiv.insertBefore(divider, insertBefore);
			} else {
			  eventsDiv.appendChild(divider);
			}
		  }

		  lastDateStr = dateStr;
		}


      const el = document.createElement('div');
      
      const timeDisplay = isAllDayEvent(e)
        ? `<span>All Day</span>`
        : `<span>${formatTimeOnly(start)}</span>
           <span class="event-duration">(${formatDurationMinutes(start, end)})</span>`;

      el.innerHTML = `
		  <strong>${e.summary}</strong><br/>
		  <span class="event-time-row">
			${timeDisplay}
		  </span>
		  <div class="${timeClass}">${formatDuration(msUntil)}</div>
		`;
      
      const customEventData = customEvents.find(ce => generateId(ce) === id);
      if (e.isCustom || customEventData) {
        const displayData = customEventData || e;
        cssClass += ' custom-colored';
        if (displayData.bgColor) el.style.backgroundColor = displayData.bgColor;
        if (displayData.textColor) {
            el.style.color = displayData.textColor;
            const durationEl = el.querySelector('.event-duration');
            if (durationEl) {
                durationEl.style.color = displayData.textColor;
                durationEl.style.opacity = '0.7';
            }
        }
      }
      el.className = cssClass + ' slide-in';
      el.dataset.id = id;
      el.dataset.start = e.start;
      el.dataset.end = e.end;
      el.dataset.msUntil = msUntil;
      el.onclick = () => showDetailsById(id);

		let inserted = false;
		for (let child of eventsDiv.children) {
		  if (child.classList.contains('event')) {
			const childStart = new Date(child.dataset.start);
			if (start < childStart) {
			  eventsDiv.insertBefore(el, child);
			  inserted = true;
			  break;
			}
		  }
		}
		if (!inserted) eventsDiv.appendChild(el);
      void el.offsetWidth;
      el.classList.add('slide-in-active');

      setTimeout(() => insertEventsSequentially(events, now, index + 1, lastDateStr), 300);
    }

    function isSameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
    }

    function formatDuration(ms) {
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const days = Math.floor(totalSeconds / (60 * 60 * 24));
      const hours = Math.floor((totalSeconds % (60 * 60 * 24)) / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      let parts = [];
      if (days > 0) parts.push(`${days} day${days !== 1 ? 's' : ''}`);
      if (hours > 0) parts.push(`${hours} hour${hours !== 1 ? 's' : ''}`);
      if (minutes > 0) parts.push(`${minutes} minute${minutes !== 1 ? 's' : ''}`);
      if (totalSeconds < 60) parts.push(`${seconds} second${seconds !== 1 ? 's' : ''}`);
      return parts.join(' ');
    }

    function formatTimeOnly(date) {
      return date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit', hour12: true });
    }

    function toLocalISOString(date) {
        const tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
        const localISOTime = (new Date(date - tzoffset)).toISOString().slice(0, -1);
        return localISOTime.substring(0, 16);
    }

    function setModalOpenState(isOpen) {
        document.body.classList.toggle('modal-open', isOpen);
    }

    function openAddEventModal(data = {}, isEditing = false) {
        const modal = document.getElementById('add-event-modal');
        setModalOpenState(true);
        const title = modal.querySelector('.modal-title');
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30 - (now.getMinutes() % 30));
        const defaultStart = new Date(now);
        const defaultEnd = new Date(now.getTime() + 60 * 60 * 1000);
        
        currentlyEditingEventId = isEditing ? generateId(data) : null;
        title.textContent = isEditing ? 'Edit Event' : 'Add New Event';

        imageUrls = [];
        let descriptionText = data.description || '';
        try {
            const descObj = JSON.parse(data.description);
            if (descObj.images) imageUrls = [...descObj.images];
            if (descObj.hasOwnProperty('text')) {
                descriptionText = descObj.text;
            } else if (descObj.images) {
                descriptionText = ''; // Clear if it was just an image object
            }
        } catch(e) {
            // Not a JSON description, treat as plain text
        }
        
        updateImagePreviewGallery();

        document.getElementById('event-summary').value = data.summary || '';
        document.getElementById('event-start').value = toLocalISOString(data.start ? new Date(data.start) : defaultStart);
        document.getElementById('event-end').value = toLocalISOString(data.end ? new Date(data.end) : defaultEnd);
        document.getElementById('event-description').value = descriptionText;
        document.getElementById('event-bg-color').value = data.bgColor || '#37474f';
        document.getElementById('event-text-color').value = data.textColor || '#eceff1';
        
        modal.style.display = 'flex';
    }

    function updateImagePreviewGallery() {
        const gallery = document.getElementById('image-preview-gallery');
        gallery.innerHTML = '';
        imageUrls.forEach((url, index) => {
            const container = document.createElement('div');
            container.className = 'thumbnail-container';
            
            const img = document.createElement('img');
            img.src = url;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'thumbnail-remove-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.onclick = () => {
                imageUrls.splice(index, 1);
                updateImagePreviewGallery();
            };
            
            container.appendChild(img);
            container.appendChild(removeBtn);
            gallery.appendChild(container);
        });
    }

    function setupAddEventModal() {
        const addBtn = document.getElementById('add-event-btn');
        const modal = document.getElementById('add-event-modal');
        const closeBtn = document.getElementById('add-event-close-btn');
        const saveBtn = document.getElementById('save-event-btn');
        const dropZone = document.getElementById('image-drop-zone');

        addBtn.onclick = () => openAddEventModal({}, false);

        closeBtn.onclick = () => {
            modal.style.display = 'none';
            setModalOpenState(false);
        }
        saveBtn.onclick = () => {
            const descriptionText = document.getElementById('event-description').value;
            let finalDescription;

            if (imageUrls.length > 0) {
                finalDescription = JSON.stringify({
                    images: imageUrls,
                    text: descriptionText
                });
            } else {
                finalDescription = descriptionText;
            }

            const eventData = {
                summary: document.getElementById('event-summary').value || 'New Event',
                start: new Date(document.getElementById('event-start').value).toISOString(),
                end: new Date(document.getElementById('event-end').value).toISOString(),
                description: finalDescription,
                bgColor: document.getElementById('event-bg-color').value,
                textColor: document.getElementById('event-text-color').value,
                isCustom: true
            };

            if (currentlyEditingEventId) {
                const index = customEvents.findIndex(e => generateId(e) === currentlyEditingEventId);
                if (index > -1) {
                    customEvents[index] = eventData;
                } else {
                    // This case handles overriding a calendar event for the first time
                    customEvents.push(eventData);
                }
            } else {
                customEvents.push(eventData);
            }

            localStorage.setItem('customEvents', JSON.stringify(customEvents));
            modal.style.display = 'none';
            setModalOpenState(false);
            renderEvents(fakeNow || new Date());
        };

        // Drag and drop for the modal's drop zone
        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', e => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
        });
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
    }
    
    function handleFiles(files) {
        [...files].forEach(file => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = e => {
                    imageUrls.push(e.target.result);
                    updateImagePreviewGallery();
                };
                reader.readAsDataURL(file);
            }
        });
    }

    function setupDragAndDrop() {
        const eventsContainer = document.getElementById('events');
        const dropMarker = document.getElementById('drop-marker');
        let lastY = 0;

        window.addEventListener('dragover', e => {
            e.preventDefault();
        });
        window.addEventListener('drop', e => {
            e.preventDefault();
        });

        eventsContainer.addEventListener('dragover', e => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            
            let targetEl = e.target.closest('.event, .date-divider');
            if (!targetEl) {
                const children = Array.from(eventsContainer.children).filter(c => c.id !== 'drop-marker');
                targetEl = children[children.length - 1];
            }
            if (!targetEl) return;

            const rect = targetEl.getBoundingClientRect();
            const isAfter = e.clientY > rect.top + rect.height / 2;
            
            dropMarker.style.display = 'block';
            if (isAfter) {
                dropMarker.style.top = `${targetEl.offsetTop + targetEl.offsetHeight}px`;
            } else {
                dropMarker.style.top = `${targetEl.offsetTop}px`;
            }
            lastY = e.clientY;
        });

        eventsContainer.addEventListener('dragleave', e => {
            if (e.relatedTarget === null || !eventsContainer.contains(e.relatedTarget)) {
                dropMarker.style.display = 'none';
            }
        });

        eventsContainer.addEventListener('drop', e => {
            e.preventDefault();
            dropMarker.style.display = 'none';
            const now = fakeNow || new Date();
            let dropTime;

            const children = Array.from(eventsContainer.children).filter(c => c.classList.contains('event'));
            let closestEl = children.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = lastY - box.top - box.height / 2;
                return offset < 0 && offset > closest.offset ? { offset: offset, element: child } : closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
            
            if(closestEl) {
                const isAfter = lastY > closestEl.getBoundingClientRect().top + closestEl.offsetHeight / 2;
                dropTime = new Date(isAfter ? closestEl.dataset.end : closestEl.dataset.start);
            } else {
                dropTime = new Date(now);
                dropTime.setMinutes(now.getMinutes() + 30 - (now.getMinutes() % 30));
            }

            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                const reader = new FileReader();
                
                reader.onload = (readEvent) => {
                    const prefill = {
                        summary: file.name.replace(/\.[^/.]+$/, ""),
                        start: dropTime,
                        end: new Date(dropTime.getTime() + 60*60*1000)
                    };
                    if (file.type.startsWith('image/')) {
                         prefill.image = readEvent.target.result;
                    } else {
                         prefill.description = readEvent.target.result;
                    }
                    openAddEventModal(prefill, false);
                };
                
                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
            }
            else {
                const text = e.dataTransfer.getData('text/plain');
                if (!text) return;
                openAddEventModal({
                    summary: text,
                    start: dropTime,
                    end: new Date(dropTime.getTime() + 60 * 60 * 1000)
                }, false);
            }
        });
    }

    function setupClipboardPaste() {
        window.addEventListener('paste', e => {
            const addEventModal = document.getElementById('add-event-modal');
            const isModalOpen = addEventModal.style.display === 'flex';

            const items = e.clipboardData.items;
            let foundImage = false;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.startsWith('image/')) {
                    foundImage = true;
                    const file = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        if (isModalOpen) {
                            imageUrls.push(event.target.result);
                            updateImagePreviewGallery();
                        } else {
                            openAddEventModal({ image: event.target.result }, false);
                        }
                    };
                    reader.readAsDataURL(file);
                    break; 
                }
            }
            if (!foundImage && !isModalOpen) {
                const text = e.clipboardData.getData('text/plain');
                if (text) {
                    openAddEventModal({ summary: text }, false);
                }
            }
        });
    }

    function showImageViewer(src) {
        const modal = document.getElementById('image-viewer-modal');
        setModalOpenState(true);
        modal.querySelector('img').src = src;
        modal.style.display = 'flex';
        modal.querySelector('.close-btn').onclick = () => {
            modal.style.display = 'none';
            setModalOpenState(false);
        }
    }

    function parseCSV(data) {
      const lines = data.trim().split(/\r?\n/);
      if (lines.length < 2) return [];
      const headers = lines[0].split(",").map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
      return lines.slice(1).map(line => {
        const values = [];
        let current = '', inQuotes = false;
        for (let char of line) {
          if (char === '"') inQuotes = !inQuotes;
          else if (char === ',' && !inQuotes) { values.push(current.trim().replace(/^"|"$/g, '')); current = ''; }
          else current += char;
        }
        values.push(current.trim().replace(/^"|"$/g, ''));
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i] || "");
        return {
          summary: obj["subject"] || "No subject",
          start: obj["start"],
          end: obj["end"],
          description: obj["description"] || "",
          rsvp: (obj["rsvp"] || "").toLowerCase(),
          ooo: (obj["ooo"] || "").toLowerCase(),
          private: (obj["private"] || "").toLowerCase()
        };
      });
    }

    function fetchAndReloadData() {
	  console.log('Reloading event data (fetchAndReloadData) at', new Date().toLocaleTimeString());
      fetch(`${fileName}?_=${Date.now()}`)
        .then(r => r.text())
        .then(data => {
          if (fileName.endsWith(".csv")) {
            eventsData = parseCSV(data);
          }
          renderEvents(fakeNow ? new Date(fakeNow.getTime()) : new Date());
        })
        .catch(err => console.error("Failed to reload file:", err));
    }

	// --- Initial Setup ---
	setupSettingsModal();
    setupAddEventModal();
    setupDragAndDrop();
    setupClipboardPaste();
    fetchAndReloadData();
	setInterval(updateTime, 1000);

	function scheduleNextReload() {
	  const now = fakeNow ? new Date(fakeNow.getTime()) : new Date();
	  let msToNext = (60 - now.getSeconds() + 1) % 60 * 1000 - now.getMilliseconds();
	  if (msToNext <= 0) msToNext += 60000; // just in case
	  console.log('msToNext:', msToNext);
	  
	  setTimeout(() => {
		fetchAndReloadData();
		setInterval(fetchAndReloadData, 60000); // After first precise reload, just repeat every minute
	  }, msToNext);
	}
	scheduleNextReload();

  </script>
</body>
</html>
